# Analyses

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  cache = FALSE,
  warning = FALSE,
  message = FALSE,
  # Save png and pdf figures
  dev = c("png", "pdf"),
  fig.ext = c("png", "pdf"),
  fig.retina = 2
)
```

```{r}
library(pacman)
p_load(
  here,
  knitr,
  patchwork,
  scales,
  broom,
  ggstance,
  tidyverse
)
```

```{r}
theme_set(
  theme_classic(base_line_size = .25, base_rect_size = 0) +
    theme(
      strip.text = element_text(size = rel(1)),
      strip.background = element_blank(),
      legend.position = "none"
    )
)
colors <- c("navyblue", "#E60012")
```

```{r}
ac <- read_rds(here("data/noa/ac-excluded.rds"))
pvz <- read_rds(here("data/ea/pvz-excluded.rds"))
ac2 <- read_rds(here("data/noa/ac.rds"))
pvz2 <- read_rds(here("data/ea/pvz.rds"))
```

## Create joint dataset

Create harmonized datasets for easier analysis

```{r}
ac <- ac %>% 
  select(
    player_id,
    spane_balance, autonomy, 
    competence, relatedness, enjoyment, 
    extrinsic, active_play, Hours
  )
pvz <- pvz %>% 
  select(
    player_id, spane_balance, autonomy, 
    competence, relatedness, enjoyment, 
    extrinsic, active_play, Hours
  )
dat <- bind_rows(pvz, ac, .id = "Study") %>% 
  mutate(Study = factor(Study, labels = c("PvZ", "AC:NH")))
```

Game time is in units of 10 hours to make the size of the coefficients bigger and thus easier to interpret e.g. when shown with 2 decimal points.

```{r}
dat$Hours10 <- dat$Hours / 10
dat$active_play10 <- dat$active_play / 10
```

## RQ1: Time and well-being

### Objective vs subjective game time

```{r}
p0 <- dat %>% 
  ggplot(aes(Hours, active_play, col = Study)) +
  scale_color_manual(values = colors) +
  geom_point(shape = 1, alpha = .5, size = .5) +
  scale_y_continuous(breaks = pretty_breaks()) +
  scale_x_continuous(breaks = pretty_breaks()) +
  geom_smooth(method = "lm", col = "black", size = .5) +
  theme(aspect.ratio = 1) +
  facet_wrap("Study", scales = "free", nrow = 2)
```

```{r}
p1 <- p0 + geom_abline(lty = 2, size = .25)
```

Model fitted separately to both datasets

```{r}
x1 <- dat %>% 
  group_by(Study) %>%
  group_modify(
    ~tidy(lm(active_play ~ Hours, data = .x), conf.int = TRUE)
  )
kable(x1, digits = c(0,0,2,2,1,3,2,2))
```

### Objective time and SWB

```{r}
p2 <- p0 + aes(y = spane_balance)
```

Model fitted separately to both datasets

```{r}
x2 <- dat %>% 
  group_by(Study) %>%
  group_modify(
    ~tidy(lm(scale(spane_balance) ~ Hours10, data = .x), conf.int = TRUE)
    )
kable(x2, digits = c(0,0,2,2,1,3,2,2))
```

### Subjective time and SWB

```{r}
p3 <- p0 + aes(x = active_play, y = spane_balance)
```

```{r}
x3 <- dat %>% 
  group_by(Study) %>% 
  group_modify(
    ~tidy(
      lm(scale(spane_balance) ~ active_play10, data = .x), 
      conf.int = TRUE
    )
  ) 
kable(x3, digits = c(0,0,2,2,1,3,2,2))
```

### Figure

```{r rq1-figure, fig.height = 4.4}
(p1 + labs(x = "Hours played", y = "Estimated hours") | 
  p2 + labs(x = "Hours played", y = "Affective well-being") | 
  p3 + labs(x = "Estimated hours", y = "Affective well-being")) &
  plot_annotation(tag_levels = "A") &
  theme(strip.text = element_blank())
```

## RQ2: Well-being and motivation

```{r}
# Nice names for plots
dat <- dat %>% rename_all(str_to_title)

# Standardize everything
# Hours (centered) is divided by 10 to put on same scale with others.
dat <- dat %>%
  group_by(Study) %>% 
  mutate(
    across(Spane_balance:Extrinsic, ~as.numeric(scale(., T, T))),
    Hours = as.numeric(scale(Hours10, T, F))
    )

# Fit all models to both datasets
xs <- dat %>% 
  group_by(Study) %>% 
  nest() %>% 
  mutate(
    # Omnibus model where variables work together
    x = map(data, ~lm(Spane_balance ~ (Autonomy + Competence + Relatedness + Enjoyment + Extrinsic) * Hours, data = .x)),
    # Separate models for variables to work alone
    x1 = map(data, ~lm(Spane_balance ~ Autonomy * Hours, data = .x)),
    x2 = map(data, ~lm(Spane_balance ~ Competence * Hours, data = .x)),
    x3 = map(data, ~lm(Spane_balance ~ Relatedness * Hours, data = .x)),
    x4 = map(data, ~lm(Spane_balance ~ Enjoyment * Hours, data = .x)),
    x5 = map(data, ~lm(Spane_balance ~ Extrinsic * Hours, data = .x))
  )
```

```{r rq2-figure, fig.height = 3}
tmp <- xs %>% 
  pivot_longer(x:x5, names_to = "Model") %>% 
  mutate(Model = ifelse(Model=="x", 'Omnibus', 'Unique')) %>% 
  mutate(out = map(value, ~tidy(., conf.int = TRUE))) %>% 
  unnest(out) %>% 
  filter(!(term %in% c('(Intercept)'))) %>%
  mutate(term = fct_rev(fct_inorder(term))) %>% 
  mutate(
    Type = factor(
      str_detect(term, ":"), labels = c("Main effect", "Moderation")
    )
  ) 
p1 <- tmp %>% 
  filter(Model == "Omnibus") %>% 
  drop_na() %>% 
  ggplot(aes(estimate, term, col = Study)) +
  scale_color_manual(values = colors) +
  scale_x_continuous(
    'Regression coefficient', breaks = pretty_breaks()
  ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  geom_pointrangeh(
    aes(xmin = conf.low, xmax = conf.high), 
    size = .4, position = position_dodgev(.25)
    ) +
  theme(axis.title.y = element_blank()) +
  facet_wrap("Study", scales = "free")
p1
```

We also compared the omnibus estimates to independent estimates

```{r}
p1 %+%
  drop_na(tmp) +
  aes(col = Model)
```
